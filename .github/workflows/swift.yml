# iOS CI/CD工作流配置文件
# 用于自动化构建、测试和归档iOS应用程序
name: iOS CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    runs-on: macos-latest
    timeout-minutes: 40  # 延长整体超时时间（默认30分钟，UI测试易超时）
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4  # 升级到最新版，兼容性更好

    - name: 设置Xcode版本
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.x'
        # 强制使用指定Xcode，避免自动切换导致的模拟器版本不匹配

    - name: 验证Xcode和模拟器版本
      run: |
        xcodebuild -version
        xcrun simctl list devices  # 打印可用模拟器，方便调试
        # 确保Xcode 16对应的模拟器版本存在（iOS 18.x是Xcode 16的默认版本）

    - name: 安装CocoaPods依赖
      run: |
        cd CICD_iOS
        pod install --repo-update  # 强制更新repo，避免依赖拉取失败

    - name: 清理DerivedData（避免缓存导致的签名问题）
      run: |
        rm -rf ~/Library/Developer/Xcode/DerivedData/*
        xcrun simctl shutdown all  # 先关闭所有模拟器
        xcrun simctl erase all     # 清空模拟器数据
        # 启动并准备测试用模拟器（避免UI测试启动超时）
        xcrun simctl boot "iPhone 16 (iOS 18.0)" || true

    - name: 主工程构建+基础测试（禁用签名）
      run: |
        cd CICD_iOS
        # 自动匹配最新可用模拟器，兼容GitHub Actions环境
        xcodebuild test \
          -workspace CICD_iOS.xcworkspace \
          -scheme CICD_iOS \
          -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
          -configuration Debug \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          ENABLE_TESTABILITY=YES 2>&1 | tee main_test.log
        
        # 精准检查测试失败（排除无关的warning）
        if grep -E "Test Failed|Build failed|error:|^    ❌" main_test.log; then
          echo "主工程测试失败："
          cat main_test.log
          exit 1
        fi

    - name: 执行单元测试（CICD_iOSTests）
      run: |
        cd CICD_iOS
        # 单独执行UT测试Scheme，聚焦单元测试结果
        xcodebuild test \
          -workspace CICD_iOS.xcworkspace \
          -scheme CICD_iOSTests \
          -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
          -configuration Debug \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          ENABLE_TESTABILITY=YES \
          -enableCodeCoverage YES 2>&1 | tee ut_test.log
        
        # 检测UT测试失败
        if grep -E "Test Failed|Build failed|error:|^    ❌" ut_test.log; then
          echo "单元测试（CICD_iOSTests）失败："
          cat ut_test.log
          exit 1
        fi

    - name: 执行UI测试（CICD_iOSUITests）
      run: |
        cd CICD_iOS
        # UI测试专属配置：禁用动画、延长超时、单例执行
        xcodebuild test \
          -workspace CICD_iOS.xcworkspace \
          -scheme CICD_iOSUITests \
          -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
          -configuration Debug \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          ENABLE_TESTABILITY=YES \
          -enableCodeCoverage YES \
          -maximum-test-execution-time-allowance 180 \
          XCUI_TESTS_DISABLE_ANIMATIONS=YES 2>&1 | tee ui_test.log
        
        # 检测UI测试失败
        if grep -E "Test Failed|Build failed|error:|^    ❌" ui_test.log; then
          echo "UI测试（CICD_iOSUITests）失败："
          cat ui_test.log
          exit 1
        fi
        
    - name: 归档构建产物（仅Push到主/开发分支且测试通过时执行）
      if: success() && github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
      run: |
        cd CICD_iOS
        mkdir -p build_artifacts
        # 归档时也禁用签名（模拟器包不需要签名）
        xcodebuild archive \
          -workspace CICD_iOS.xcworkspace \
          -scheme CICD_iOS \
          -configuration Release \
          -archivePath build_artifacts/CICD_iOS \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: 上传构建产物
      if: success() && github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
      uses: actions/upload-artifact@v4
      with:
        name: iOS-Build-Artifacts
        path: CICD_iOS/build_artifacts/
        retention-days: 7  # 产物保留7天，避免占用空间

    - name: 失败时上传所有测试日志（调试用）
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs
        path: |
          CICD_iOS/main_test.log
          CICD_iOS/ut_test.log
          CICD_iOS/ui_test.log
